name: Deploy to AWS Lambda

on:
  push:
    branches:
      - main  # Trigger when you push to the 'main' branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Zip Lambda function (no dependencies)
      run: |
        cd lambda/iot_lambda_func
        zip -r function.zip inventory_logger.py

    - name: Deploy to AWS Lambda
      uses: aws-actions/aws-lambda-deploy@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: eu-north-1
        function-name: iot_lambda_func
        zip-file: lambda/iot_lambda_func/function.zip

    - name: Trigger Lambda Test Event
      run: |
        aws lambda invoke \
          --function-name iot_lambda_func \
          --region eu-north-1 \
          --payload "{\"body\": \"{\\\"item_id\\\": 1, \\\"movement\\\": \\\"TEST\\\", \\\"quantity\\\": 10, \\\"timestamp\\\": \\\"$(date -u +'%Y-%m-%dT%H:%M:%SZ')\\\"}\"}" \
          response.json
