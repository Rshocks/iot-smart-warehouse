name: Deploy and Test AWS Lambda 

on:
  push:
    branches:
      - main  # Trigger this action when you push to the 'main' branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Deploy to AWS Lambda
      uses: aws-actions/aws-lambda-deploy-python@v1.1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: eu-north-1
        function-name: iot_lambda_func
        src-path: lambda/iot_lambda_func/inventory_logger.py

    - name: Test Deployed Lambda Function
      uses: aws-actions/aws-cli-action@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: eu-north-1
        command: |
          aws lambda invoke \
            --function-name iot_lambda_func \
            --payload "{\"body\": \"{\\\"item_id\\\": 1, \\\"movement\\\": \\\"TEST\\\", \\\"quantity\\\": 10, \\\"timestamp\\\": \\\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\\\"}\"}" \
            response.json
